# 20240809 [TIL] 챕터. 1 과제 수행 - 도전과제 JWT 검증
<br>

---
<br>
<br>
<br>

```
 - 도전 과제중 JWT 토큰이 회원가입한 유저의 토큰인지 검증하는 로직을 구현 하는중에 많은 고민을 하게 되었다.

```


---
## JWT 토큰 검증

- JWT 토큰의 회원 정보가 실제 회원가입한 회원인지 검증 하는 로직을 구현 하는중 
- 검증 로직을 어디에서 수행할지 고민 하게 됐다.
### 내가 생각한 방법 2가지
### 1.각서비스에서 검증한다 
- 이경우 gateway에서는 토큰 검증만 진행하고 토큰에 담긴 회원 정보를 전해 주거나 토큰을 넘긴다
- 그럼 각 서비스에서 토큰을 검증하고 회원정보를 꺼내 auth 서비스를 호출해서 검증한다
- 각 서비스마다 jwt 라이브러리 설정을 해야하고 auth 서비스를 매번 호출 하니 auth 서비스 부하가 생간다.
- MSA 설계에서 서비스가 작으면 괜찮을지 몰라도 서비스가 많아질수록 공통 설정이나 jwt 관련된 것들을 일일이 다 설정해야하는 번거러움이 있다.

### 2.auth 서비스에서 검증한다
   - 이경우 product 서비스나 order 서비스를 호출 할때도 매번 auth 서비스를 호출 해야 한다 
   - 혼자 테스트 할때야 괜찮지만 이용자가 많다고 가정해 보면 auth서비스에 부하가 굉장히 많이 끼칠 꺼라 생각했다.
   - 또한 검증 후에 다른 서비스에서 회원 정보를 이용 하려면 auth 서비스를 또 호출 해야한다
   - jwt 의존은 gateway만 하면 된다.

---
### 그래서 나는 gateway에서 검증 및 auth 서비스를 호출해 회원가입여부를 검증하고 회원정보를
### 캐시에 저장후 각 서비스에서 회원 정보를 호출 할때 캐시 정보를 읽는 방법으로 auth 서비스의 부하를 줄이는 방법을 생각했다
### 캐시에 회원정보가 담기면 회원정보가 변경됐을때 데이터 불일치가 생길수 있으니 회원정보가 변경되면 캐시데이터를 갱신 하는 방법을 사용하고
### username은 변경될일이 거의 없고 role 정도가 변경될수가 있기 때문에 갱신될일이 잘 없긴 하다.
### 캐시를 TTL로 설정해 적당한 시간을 줘 캐시데이터의 데이터 양도 조절 하면 되겠다고 생각했다.
### netflix 나 toss 에서는 이 방법으로 auth 서비스에서 passport 를 발급하는 방법으로 서버 부하를 줄이고 회원정보를 전달 한다고 한다
### 나는 우선 passport는 발급하지 않고 검증에 성공하면 username을 캐시에 저장하고 넘기는 방법을 선택했다.


## 그러던중 문제가 발생했다.
- gateway 에서 auth 서비스를 호출해 회원검증을 하려고 feignClient 를 사용하 였는데 
- 의존성 순환 문제가 발생했다.
- @Lazy 를 auth feign client 에 붙여 해결 하였는데 
- HttpMessageConverter 빈을 찾지 못헤 오류가 발생했다 
- 직접 빈등록을 해주어 해결했다.

<br>

- 찾아보니 @Lazy나 .yml설정으로 순환참조를 허용하는 방법은 좋지 않고 순환을 끊어주는 구조로 리펙토링을 하는게 좋다고 한다
- 나는 아직 지식이 부족해서 더 공부 한 후에 코드 리펙토링을 해야 겠다.
